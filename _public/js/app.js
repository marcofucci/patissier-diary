"use strict";var App=angular.module("app",["ngCookies","ngResource","ngRoute","app.states","angularMoment","textAngular","ui.bootstrap","ui.router","app.routes","app.services","app.controllers","app.directives","app.filters","partials"]);App.run(["$state",function(e){e.go("type_detail",{typeId:1})}]),App.config(function(){var e=require("nw.gui"),t=e.Window.get(),r=new e.Menu({type:"menubar"});try{r.createMacBuiltin("My App"),t.menu=r}catch(n){console.log(n.message)}});var DEBUG=!1,Constants={DB_PATH:process.env.HOME+"/Dropbox/marconess/patissier"+(DEBUG?"_dev":"")+"/data.db",IMG_PATH:process.env.HOME+"/Dropbox/marconess/patissier"+(DEBUG?"_dev":"")+"/images/"};angular.module("app.controllers",[]).controller("LayoutCtrl",["$scope","types",function(e,t){e.types=t}]).controller("TypeDetailCtrl",["$scope","type","recipes",function(e,t,r){e.$parent.current_type=t,e.recipes=r}]).controller("RecipeDetailCtrl",["$scope","type","recipe","tests","$modal","$sce",function(e,t,r,n,o,a){function i(e){o.open({templateUrl:"/partials/test_modal.html",controller:"TestModalCtrl",resolve:{recipe:function(){return r},test:function(){var t={};return angular.copy(e,t),e}}})}e.$parent.current_type=t,e.recipe=r,e.tests=n,e.addTest=function(){i({recipe:r._id})},e.changeTest=function(e){i(e)},e.renderHtml=function(e){return a.trustAsHtml(e.replace(/\n/g,"<br/>"))},e.openImage=function(e){o.open({templateUrl:"/partials/img_modal.html",controller:["$scope","img",function(e,t){e.img=t,e.cancel=function(){e.$dismiss("cancel")}}],resolve:{img:function(){return e}}})},e.openRecipeNotes=function(){o.open({templateUrl:"/partials/recipe_notes_modal.html",controller:"RecipeNotesModalCtrl",size:"lg",resolve:{recipe:function(){return r}}})}}]).controller("TestModalCtrl",["$scope","recipe","test","db","$state",function(e,t,r,n,o){e.recipe=t,e.add=void 0===r._id,e.test=r,e.activeTab="general",e.changeTab=function(t){e.activeTab=t};var a=function(){e.cancel(),o.reload()};e.cancel=function(){e.$dismiss("cancel")},e.save=function(){if(r.temp_img){var t=require("fs"),o=require("path"),i=o.extname(r.temp_img),l=require("crypto").randomBytes(64).toString("hex"),c=o.join(Constants.IMG_PATH,l+i);t.createReadStream(r.temp_img).pipe(t.createWriteStream(c)),r.img=c.replace(process.env.HOME,"$HOME"),delete r.temp_img}n.test.saveOrUpdate(e.test,a)},e["delete"]=function(){n.test["delete"](e.test,a)},e.opened=!1,e.openCalendar=function(t){t.preventDefault(),t.stopPropagation(),e.opened=!0}}]).controller("RecipeNotesModalCtrl",["$scope","recipe","db","$state",function(e,t,r,n){e.recipe=t,e.edit=!1,e.changeEdit=function(t){e.edit=t},e.close=function(){e.$dismiss("cancel"),n.reload()}}]).controller("MontlyProgressCtrl",["$scope","data","dates","currentMonth","$state",function(e,t,r,n,o){e.data=t,e.dates=r,e.current_month=n,e.$watch("current_month",function(e){o.go("monthly_progress",{month:e})})}]).controller("MemosCtrl",["$scope","memos","db",function(e,t,r){var n=require("wait.for");e.memos=t,e.add=function(){var t=e.newMemoText.trim();0!==t.length&&n.launchFiber(function(){var o={text:t,date:new Date},o=n["for"](r.memo.saveOrUpdate,o);e.memos.unshift(o),e.memos=e.memos,e.newMemoText="",e.$apply()})},e.remove=function(o){n.launchFiber(function(){e.memos.splice(t.indexOf(o),1),n["for"](r.memo["delete"],o)})},e.update=function(t){var o=t;n.launchFiber(function(){var t=n["for"](r.memo.saveOrUpdate,o);e.memos[e.memos.indexOf(t)]=t})}}]);var DataStore={};DataStore.create=function(e){return"simple"==e?createSimpleStore():"relational"==e?createRelationalStore():"document"==e?createDocumentStore():void 0};var createSimpleStore=function(){},createRelationalStore=function(){},createDocumentStore=function(){try{var e=require("nedb"),t={collection:function(t){return new e({filename:Constants.DB_PATH+"///"+t,autoload:!0})}};return t}catch(r){console.error("MODULE_NOT_FOUND"==r.code?"NeDB not found. Try `npm install nedb --save` inside of `/app/assets`.":r)}};angular.module("app.directives",["app.services"]).directive("ngReallyClick",[function(){return{restrict:"A",link:function(e,t,r){t.bind("click",function(){var t=r.ngReallyMessage;t&&confirm(t)&&e.$apply(r.ngReallyClick)})}}}]).directive("notesForm",["$timeout","db",function(e,t){return{restrict:"E",require:"ngModel",templateUrl:"/partials/notes_form.html",scope:{model:"=ngModel",ref:"@ngModel"},link:function(r){var n=100,o=null,a=!1,i=function(){a=!1},l=function(t,a){t!==a&&(o&&e.cancel(o),o=e(r.save,n))};r.save=function(){e.cancel(o),a||(a=!0,t.recipe.saveNotes(r.model,i))},r.$watch("model.ingredients",l),r.$watch("model.procedure",l),r.$watch("model.cooking_time",l),r.$watch("model.materials",l)}}}]).directive("monthlyStats",[function(){return{restrict:"E",scope:{val:"="},link:function(e,t){var r={top:20,right:20,bottom:70,left:210},n=900-r.left-r.right,o=1e3-r.top-r.bottom,a=d3.scale.linear().range([0,n]),i=d3.scale.ordinal().rangeRoundBands([0,o],.05),l=d3.select(t[0]).append("svg").attr("width",n+r.left+r.right).attr("height",o+r.top+r.bottom).append("g").attr("transform","translate("+r.left+","+r.top+")"),c=[];e.val.forEach(function(e){c=c.concat(e.recipes)}),a.domain([0,d3.max(c,function(e){return e.count})]),i.domain(c.map(function(e){return e.recipe}));var s=d3.svg.axis().scale(a).orient("bottom");l.append("g").attr("class","x axis").attr("transform","translate(0,"+o+")").call(s).selectAll("text").style("text-anchor","end");var u=d3.svg.axis().scale(i).orient("left").ticks(10);l.append("g").attr("class","y axis").call(u),l.selectAll("bar").data(c).enter().append("rect").style("fill",function(e){var t=e.type._id;return"rgb("+10*t+", "+20*t+", "+40*t+")"}).attr("x",function(){return 0}).attr("width",function(e){return a(e.count)}).attr("y",function(e){return i(e.recipe)}).attr("height",i.rangeBand())}}}]).directive("starRating",["$timeout",function(){return{restrict:"E",require:"ngModel",templateUrl:"/partials/star_rating.html",scope:{model:"=ngModel",ref:"@ngModel",readonly:"=",size:"="},link:function(e,t){$(".rating",t).rating({size:e.size||"xs",showClear:!1,showCaption:!1,readonly:e.readonly}).rating("update",e.model).on("rating.change",function(t,r){e.model=parseFloat(r)})}}}]),angular.module("app.filters",[]).filter("interpolate",["version",function(e){return function(t){return String(t).replace(/\%VERSION\%/gm,e)}}]).filter("nl2br",function(){return function(e){return"undefined"!=typeof e&&e?e.replace(/\n/g,"<br/>"):void 0}}).provider("$home",function(){this.$get=[function(){return function(e){return void 0!==e&&e?e.replace("$HOME",process.env.HOME):e}}]}).filter("home",["$home",function(e){return e}]),function(){angular.module("app.routes",[]).config(["$stateProvider","$locationProvider",function(e,t){t.html5Mode(!0);var r=angular.module("app.states").getStates();angular.forEach(r,function(t){e.state(t)})}])}(),angular.module("app.services",[]).factory("version",function(){return"0.1"}).factory("db",[function(){var e=DataStore.create("document"),t=e.collection("type"),r=e.collection("subtype"),n=e.collection("recipe"),o=e.collection("test"),a=e.collection("memo"),i={type:{getAll:function(e){return t.find({},e)},getById:function(e,r){return t.findOne({_id:parseInt(e)},r)}},subtype:{getAllByTypeId:function(e,t){return r.find({type:parseInt(e)},t)},getById:function(e,t){return r.findOne({_id:parseInt(e)},t)}},recipe:{getAllByTypeId:function(e,t,r){var o={type:parseInt(e)};return t&&(o.subtype={$exists:!1}),n.find(o,r)},getAllBySubTypeId:function(e,t){return n.find({subtype:parseInt(e)}).sort({order:1}).exec(t)},getById:function(e,t){return n.findOne({_id:parseInt(e)},t)},getStats:function(e,t){o.count({recipe:parseInt(e)},function(r,n){0==n?t(r,{count:n,lastTest:null,avRating:0}):o.find({recipe:parseInt(e)}).sort({date:-1}).exec(function(e,r){var o=r[0],a=0;angular.forEach(r,function(e){a+=e.rating||0}),a/=n,a=Math.ceil(10*a)/10,t(e,{count:n,lastTest:o,avRating:a})})})},getCountPerMonth:function(e,t,r){var n={recipe:parseInt(e)};if(t){var a=t.split("/"),t=parseInt(a[0])-1,i=parseInt(a[1]),l=new Date(i,t,1,0,0,0,0),c=new Date(i,t+1,1,0,0,0,0);n.date={$gt:l,$lt:c}}o.count(n,r)},saveNotes:function(e,t){n.update({_id:e._id},{$set:{notes:e.notes,ingredients:e.ingredients,procedure:e.procedure,cooking_time:e.cooking_time,materials:e.materials}},t)}},test:{getAllByRecipeId:function(e,t){return o.find({recipe:parseInt(e)}).sort({date:-1}).exec(t)},saveOrUpdate:function(e,t){void 0!=e._id?o.update({_id:e._id},{$set:{rating:e.rating,date:e.date,img:e.img,notes:e.notes,aspect_obs:e.aspect_obs,aspect_corr:e.aspect_corr,smell_obs:e.smell_obs,smell_corr:e.smell_corr,taste_obs:e.taste_obs,taste_corr:e.taste_corr,texture_obs:e.texture_obs,texture_corr:e.texture_corr}},function(e,r,n){t(e,n)}):o.insert(e,t)},"delete":function(e,t){o.remove({_id:e._id},t)},getAllMonths:function(e){var t=[];o.find({}).sort({date:-1}).exec(function(r,n){n.forEach(function(e){var r=e.date.getMonth()+1+"/"+e.date.getFullYear();-1==t.indexOf(r)&&t.push(r)}),e(r,t)})}},memo:{getAll:function(e){return a.find({}).sort({date:-1}).exec(e)},saveOrUpdate:function(e,t){void 0!=e._id?a.update({_id:e._id},{$set:{date:e.date,text:e.text}},function(e,r,n){t(e,n)}):a.insert(e,t)},"delete":function(e,t){a.remove({_id:e._id},t)}}};return i}]),function(){var e=angular.module("app.states",[]);e.getStates=function(){var e={};return e.Layout={name:"layout","abstract":!0,resolve:{types:["db","$q",function(e,t){var r=t.defer();return e.type.getAll(function(e,t){r.resolve(t)}),r.promise}]},views:{"@":{templateUrl:"/partials/base.html"},"nav@layout":{templateUrl:"/partials/nav.html",controller:"LayoutCtrl"}}},e.Dashboard={name:"dashboard",parent:"layout",url:"#dashboard",templateUrl:"/partials/dashboard.html"},e.TypeDetail={name:"type_detail",parent:"layout",url:"#type={typeId}",templateUrl:"/partials/type_detail.html",controller:"TypeDetailCtrl",resolve:{type:["$stateParams","$q","db",function(e,t,r){var n=t.defer();return r.type.getById(e.typeId,function(e,t){n.resolve(t)}),n.promise}],recipes:["$stateParams","$q","db",function(e,t,r){var n=t.defer(),o=require("wait.for");return o.launchFiber(function(){var t=[],a=o["for"](r.subtype.getAllByTypeId,e.typeId);angular.forEach(a,function(e){var n=o["for"](r.recipe.getAllBySubTypeId,e._id);n.length&&t.push({group:e.name,recipes:n})});var i=o["for"](r.recipe.getAllByTypeId,e.typeId,!0);i.length&&t.push({group:t.length?"Other":"",recipes:i}),angular.forEach(t,function(e){angular.forEach(e.recipes,function(e){var t=o["for"](r.recipe.getStats,e._id);e.stats={count:t.count,lastTest:t.lastTest,avRating:t.avRating}}),n.resolve(t)})}),n.promise}]}},e.RecipeDetail={name:"recipe_detail",parent:"layout",controller:"RecipeDetailCtrl",url:"#type={typeId}&recipe={recipeId}",templateUrl:"/partials/recipe_detail.html",resolve:{type:["$stateParams","$q","db",function(e,t,r){var n=t.defer();return r.type.getById(e.typeId,function(e,t){n.resolve(t)}),n.promise}],recipe:["$stateParams","$q","db",function(e,t,r){var n=t.defer();return r.recipe.getById(e.recipeId,function(e,t){n.resolve(t)}),n.promise}],tests:["$stateParams","$q","db",function(e,t,r){var n=t.defer();return r.test.getAllByRecipeId(e.recipeId,function(e,t){n.resolve(t)}),n.promise}]}},e.MonthlyProgress={name:"monthly_progress",parent:"layout",controller:"MontlyProgressCtrl",url:"#monthly_progress&month={month}",templateUrl:"/partials/monthly_progress.html",resolve:{dates:["$q","db",function(e,t){var r=e.defer();return t.test.getAllMonths(function(e,t){r.resolve(t)}),r.promise}],currentMonth:["$stateParams",function(e){return e.month}],data:["$q","db","types","currentMonth",function(e,t,r,n){var o=e.defer(),a=require("wait.for");return a.launchFiber(function(){var e=[];angular.forEach(r,function(r){if(!r.component){var o={type:r,recipes:[]},i=a["for"](t.recipe.getAllByTypeId,r._id,!1);angular.forEach(i,function(e){var i=a["for"](t.recipe.getCountPerMonth,e._id,n);o.recipes.push({type:r,recipe:e.name,at_exam:!!e.at_exam,count:i})}),e.push(o)}}),o.resolve(e)}),o.promise}]}},e.MemosList={name:"memos_list",parent:"layout",controller:"MemosCtrl",url:"#memos",templateUrl:"/partials/memos_list.html",resolve:{memos:["db","$q",function(e,t){var r=t.defer();return e.memo.getAll(function(e,t){r.resolve(t)}),r.promise}]}},e}}();