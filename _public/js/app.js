"use strict";var App=angular.module("app",["ngCookies","ngResource","ngRoute","app.states","angularMoment","textAngular","ui.bootstrap","ui.router","app.routes","app.services","app.controllers","app.directives","app.filters","partials"]);App.run(["$state",function(e){e.go("type_detail",{typeId:1})}]);var Constants={DB_PATH:process.env.HOME+"/Dropbox/patissier/data.db",IMG_PATH:process.env.HOME+"/Dropbox/patissier/images/"};angular.module("app.controllers",[]).controller("LayoutCtrl",["$scope","types",function(e,t){e.types=t}]).controller("TypeDetailCtrl",["$scope","type","recipes",function(e,t,r){e.$parent.current_type=t,e.recipes=r}]).controller("RecipeDetailCtrl",["$scope","type","recipe","tests","$modal","$sce",function(e,t,r,n,a,o){function i(e){a.open({templateUrl:"/partials/test_modal.html",controller:"TestModalCtrl",resolve:{recipe:function(){return r},test:function(){var t={};return angular.copy(e,t),t}}})}e.$parent.current_type=t,e.recipe=r,e.tests=n,e.addTest=function(){i({recipe:r._id})},e.changeTest=function(e){i(e)},e.renderHtml=function(e){return o.trustAsHtml(e.replace(/\n/g,"<br/>"))},e.openImage=function(e){a.open({templateUrl:"/partials/img_modal.html",controller:["$scope","img",function(e,t){e.img=t,e.cancel=function(){e.$dismiss("cancel")}}],resolve:{img:function(){return e}}})},e.openRecipeNotes=function(){a.open({templateUrl:"/partials/recipe_notes_modal.html",controller:"RecipeNotesModalCtrl",backdrop:"static",resolve:{recipe:function(){var e={};return angular.copy(r,e)}}})}}]).controller("TestModalCtrl",["$scope","recipe","test","db","$state",function(e,t,r,n,a){e.recipe=t,e.add=void 0===r._id,e.test=r,e.activeTab="general",e.changeTab=function(t){e.activeTab=t};var o=function(){e.cancel(),a.reload()};e.cancel=function(){e.$dismiss("cancel")},e.save=function(){if(r.temp_img){var t=require("fs"),a=require("path"),i=a.extname(r.temp_img),c=require("crypto").randomBytes(64).toString("hex"),l=a.join(Constants.IMG_PATH,c+i);t.createReadStream(r.temp_img).pipe(t.createWriteStream(l)),r.img=l,delete r.temp_img}n.test.saveOrUpdate(e.test,o)},e["delete"]=function(){n.test["delete"](e.test,o)},e.opened=!1,e.openCalendar=function(t){t.preventDefault(),t.stopPropagation(),e.opened=!0}}]).controller("RecipeNotesModalCtrl",["$scope","recipe","db","$state",function(e,t,r,n){e.recipe=t,e.new_recipe={},e.edit=!1,e.changeEdit=function(t){e.edit=t,t&&angular.copy(e.recipe,e.new_recipe)};e.close=function(){e.$dismiss("cancel")},e.cancel=function(){e.edit=!1},e.save=function(){r.recipe.saveNotes(t,function(){}),e.recipe=e.new_recipe,e.edit=!1}}]);var DataStore={};DataStore.create=function(e){return"simple"==e?createSimpleStore():"relational"==e?createRelationalStore():"document"==e?createDocumentStore():void 0};var createSimpleStore=function(){},createRelationalStore=function(){},createDocumentStore=function(){try{var e=require("nedb"),t={collection:function(t){return new e({filename:Constants.DB_PATH+"///"+t,autoload:!0})}};return t}catch(r){console.error("MODULE_NOT_FOUND"==r.code?"NeDB not found. Try `npm install nedb --save` inside of `/app/assets`.":r)}};angular.module("app.directives",["app.services"]).directive("ngReallyClick",[function(){return{restrict:"A",link:function(e,t,r){t.bind("click",function(){var t=r.ngReallyMessage;t&&confirm(t)&&e.$apply(r.ngReallyClick)})}}}]),angular.module("app.filters",[]).filter("interpolate",["version",function(e){return function(t){return String(t).replace(/\%VERSION\%/gm,e)}}]).filter("nl2br",function(){return function(e){return"undefined"!=typeof e&&e?e.replace(/\n/g,"<br/>"):void 0}}),function(){angular.module("app.routes",[]).config(["$stateProvider","$locationProvider",function(e,t){t.html5Mode(!0);var r=angular.module("app.states").getStates();angular.forEach(r,function(t){e.state(t)})}])}(),angular.module("app.services",[]).factory("version",function(){return"0.1"}).factory("db",[function(){var e=DataStore.create("document"),t=e.collection("type"),r=e.collection("subtype"),n=e.collection("recipe"),a=e.collection("test"),o={type:{getAll:function(e){return t.find({},e)},getById:function(e,r){return t.findOne({_id:parseInt(e)},r)}},subtype:{getAllByTypeId:function(e,t){return r.find({type:parseInt(e)},t)},getById:function(e,t){return r.findOne({_id:parseInt(e)},t)}},recipe:{getAllByTypeId:function(e,t,r){var a={type:parseInt(e)};return t&&(a.subtype={$exists:!1}),n.find(a,r)},getAllBySubTypeId:function(e,t){return n.find({subtype:parseInt(e)}).sort({order:1}).exec(t)},getById:function(e,t){return n.findOne({_id:parseInt(e)},t)},getStats:function(e,t){a.count({recipe:parseInt(e)},function(r,n){0==n?t(r,n,null,0):a.find({recipe:parseInt(e)}).sort({date:-1}).exec(function(e,r){var a=r[0],o=0;angular.forEach(r,function(e){o+=e.rating||0}),o/=n,o=Math.ceil(10*o)/10,t(e,n,a,o)})})},saveNotes:function(e,t){n.update({_id:e._id},{$set:{notes:e.notes}},t)}},test:{getAllByRecipeId:function(e,t){return a.find({recipe:parseInt(e)}).sort({date:-1}).exec(t)},saveOrUpdate:function(e,t){void 0!=e._id?a.update({_id:e._id},{$set:{rating:e.rating,date:e.date,img:e.img,notes:e.notes,aspect_obs:e.aspect_obs,aspect_corr:e.aspect_corr,smell_obs:e.smell_obs,smell_corr:e.smell_corr,taste_obs:e.taste_obs,taste_corr:e.taste_corr,texture_obs:e.texture_obs,texture_corr:e.texture_corr}},function(e,r,n){t(e,n)}):a.insert(e,t)},"delete":function(e,t){a.remove({_id:e._id},t)}}};return o}]),function(){var e=angular.module("app.states",[]);e.getStates=function(){var e={};return e.Layout={name:"layout","abstract":!0,resolve:{types:["db","$q",function(e,t){var r=t.defer();return e.type.getAll(function(e,t){r.resolve(t)}),r.promise}]},views:{"@":{templateUrl:"/partials/base.html"},"nav@layout":{templateUrl:"/partials/nav.html",controller:"LayoutCtrl"}}},e.Dashboard={name:"dashboard",parent:"layout",url:"#dashboard",templateUrl:"/partials/dashboard.html"},e.TypeDetail={name:"type_detail",parent:"layout",url:"#type={typeId}",templateUrl:"/partials/type_detail.html",controller:"TypeDetailCtrl",resolve:{type:["$stateParams","$q","db",function(e,t,r){var n=t.defer();return r.type.getById(e.typeId,function(e,t){n.resolve(t)}),n.promise}],recipes:["$stateParams","$q","db",function(e,t,r){var n=t.defer(),a=[];return r.subtype.getAllByTypeId(e.typeId,function(t,o){angular.forEach(o,function(e){r.recipe.getAllBySubTypeId(e._id,function(t,r){a.push({group:e.name,recipes:r})})}),r.recipe.getAllByTypeId(e.typeId,!0,function(e,t){t.length&&a.push({group:a.length?"Other":"",recipes:t}),angular.forEach(a,function(e){angular.forEach(e.recipes,function(e){r.recipe.getStats(e._id,function(t,r,n,a){e.stats={count:r,lastTest:n,avRating:a}})})}),n.resolve(a)})}),n.promise}]}},e.RecipeDetail={name:"recipe_detail",parent:"layout",controller:"RecipeDetailCtrl",url:"#type={typeId}&recipe={recipeId}",templateUrl:"/partials/recipe_detail.html",resolve:{type:["$stateParams","$q","db",function(e,t,r){var n=t.defer();return r.type.getById(e.typeId,function(e,t){n.resolve(t)}),n.promise}],recipe:["$stateParams","$q","db",function(e,t,r){var n=t.defer();return r.recipe.getById(e.recipeId,function(e,t){n.resolve(t)}),n.promise}],tests:["$stateParams","$q","db",function(e,t,r){var n=t.defer();return r.test.getAllByRecipeId(e.recipeId,function(e,t){n.resolve(t)}),n.promise}]}},e}}();